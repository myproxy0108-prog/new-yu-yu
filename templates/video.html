<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex,nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>勉強に集中したい！勉強への集中力をアップする方法とは？</title>
    <link rel="icon" href="/img/logo/favicon.ico">

    <!-- CSS: 基本 + タブ微調整 -->
    <link rel="stylesheet" href="/css/pure-min.css">
    <link rel="stylesheet" href="/css/grids-responsive-min.css">
    <link rel="stylesheet" href="/css/ionicons.min.css">
    <link rel="stylesheet" href="/css/default.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=thumb_up" />

    <style>
      :root {
        --bg: #ffffff;
        --text-primary: #0f0f0f;
        --text-secondary: #606060;
        --accent: #007BFF;
      }
      body {
        font-family: Roboto, Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
      }
      div.thumbnail { /* legacy kept but not used for right column thumbnails */ }

      /* メインレイアウト */
      .main-content { margin-top: 56px; min-height: calc(100vh - 56px); padding: 16px; }
      .video-container { display: flex; gap: 16px; align-items: flex-start; }
      .video-left { flex: 1 1 70%; min-width: 0; }
      .video-right { flex: 0 0 320px; max-width: 35%; }

      /* 動画プレーヤー */
      .video-player-wrapper { position: relative; }
      .video-player-wrapper video { width: 100%; aspect-ratio: 16 / 9; background: #000; display:block; }
      #loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        display: none;
        pointer-events: none;
      }
      @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

      .video-description { margin-top: 16px; background-color: #f9f9f9; padding: 12px; border-radius: 4px; text-align: left; }
      .comments-section { margin-top: 16px; background-color: #ffffff; padding: 12px; border: 1px solid rgba(0,0,0,0.08); border-radius: 4px; text-align: left; }
      .comments-section h3 { margin-top: 0; font-size: 18px; margin-bottom: 8px; }

      /* 右カラムサムネイル（命名衝突回避） */
      .video-right .recomeention { display: block; margin-bottom: 12px; padding: 6px 4px; border-radius: 8px; }
      .video-right .recomeention > a { display: flex; align-items: flex-start; gap: 10px; text-decoration: none; color: inherit; padding: 4px 2px; }
      .video-right .recomeention > a .thumb-area {
        padding: 0; width: 120px; flex: 0 0 120px; box-sizing: border-box; height: 67.5px; overflow: hidden; border-radius: 6px; background:#000; position:relative;
      }
      .video-right .recomeention > a .thumb-area img.thumb-img { width:100%; height:100%; object-fit:cover; display:block; border-radius:6px; }
      .video-right .recomeention > a .thumb-area .length { position:absolute; right:6px; bottom:6px; background:rgba(0,0,0,0.75); color:#fff; font-size:12px; padding:2px 6px; border-radius:4px; line-height:1; }
      .video-right .recomeention > a p { font-size:0.95rem; font-weight:600; color:var(--text-primary); line-height:1.2; display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; overflow:hidden; text-overflow:ellipsis; white-space:normal; min-width:0; }
      .video-right .recomeention > p, .video-right .recomeention > a + p, .video-right .recomeention > a + p + a { font-size:0.82rem; color:var(--text-secondary); margin:6px 0 0 0; }

      /* トップバー */
      #top-bar { display:flex; align-items:center; justify-content:space-between; background:#fff; height:56px; padding:0 15px; box-shadow:0 2px 4px rgba(0,0,0,0.1); position:fixed; top:0; left:0; right:0; z-index:1000; }
      #top-bar .left-section { display:flex; align-items:center; }
      #open-sidebar { font-size:30px; background:none; border:none; cursor:pointer; color:var(--accent); }

      /* サイドバー（省略） */
      #sidebar { position:fixed; top:56px; left:-100%; width:80%; max-width:300px; height:calc(100% - 56px); background:#000; color:#fff; transition:left .3s ease; z-index:1100; }

      /* 歯車（左下） */
      .settings-toggle { position: fixed; left: 18px; bottom: 18px; z-index: 150; background: transparent; border: none; cursor: pointer; font-size: 20px; color: #fff; display: flex; align-items: center; gap: 8px; padding: 0; }
      .settings-toggle .gear { width: 44px; height: 44px; border-radius: 10px; background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.18); color: #fff; font-size: 20px; }

      /* 設定パネル */
      .settings-panel {
        position: fixed; bottom: 78px; left: 18px; width: 320px; max-width: calc(100% - 36px);
        background: #ffffff; border-radius: 12px; box-shadow: 0 14px 40px rgba(0,0,0,0.18); padding: 16px; z-index: 160;
        transform-origin: bottom left; transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease; opacity: 0; transform: translateY(10px) scale(.98); pointer-events: none;
      }
      .settings-panel.open { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }
      .settings-panel h4 { margin: 0 0 10px; font-size: 1rem; color: #222; }

      .settings-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.04); }
      .settings-row:last-child { border-bottom:none; }
      .settings-row label { font-size:0.92rem; color:#333; }
      .settings-row .desc { font-size:0.8rem; color:#666; display:block; margin-top:6px; }

      /* タブUI 微調整 */
      .settings-tabs { display:flex; gap:8px; margin-bottom:10px; }
      .settings-tabs .tab {
        background: transparent; border: 1px solid rgba(0,0,0,0.06); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:0.95rem; color:var(--text-primary);
      }
      .settings-tabs .tab[aria-selected="true"] {
        background: var(--accent); color:#fff; border-color: rgba(0,0,0,0.06); box-shadow: 0 6px 18px rgba(2, 85, 204, 0.12);
      }
      .tab-panel { margin-top:6px; }
      .settings-save { padding:8px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.08); background:var(--accent); color:#fff; cursor:pointer; }

      /* トースト */
      .toast-wrap { position: fixed; top: 20px; right: 20px; z-index: 170; display:flex; flex-direction:column; gap:10px; pointer-events:none; }
      .toast { min-width:220px; max-width:360px; background: linear-gradient(180deg,#fff,#f6f9ff); border-radius:10px; padding:12px 14px; box-shadow:0 10px 30px rgba(14,30,37,0.12); color:#042a4a; font-size:0.95rem; border-left:4px solid var(--accent); transform: translateX(12px) translateY(-8px) scale(.98); opacity:0; transition: transform 300ms cubic-bezier(.2,.9,.2,1), opacity 240ms ease; pointer-events:auto; position:relative; touch-action:pan-y; user-select:none; }
      .toast.show { transform: translateX(0) translateY(0) scale(1); opacity:1; }
      .toast .title { font-weight:700; margin-bottom:6px; }
      .toast .body { font-weight:500; color:#234; }
      .toast .close-x { position:absolute; top:6px; right:8px; font-weight:700; color:rgba(0,0,0,0.45); cursor:pointer; background:none; border:none; }
      .toast.dragging { transition:none; opacity:0.95; }

      /* レスポンシブ */
      @media (max-width: 768px) {
        .video-container { flex-direction: column; gap: 12px; }
        .video-right { order: 2; width: 100%; max-width: none; }
        .video-left { order: 1; width: 100%; }
        .settings-panel { left: 12px; right: 12px; width: auto; max-width: calc(100% - 24px); }
      }

      @media (prefers-reduced-motion: reduce) {
        * { animation: none !important; transition: none !important; }
      }
    </style>

    <!-- 外部スクリプトは1回だけ、defer推奨 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" defer></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous" defer></script>
  </head>

  <body>
    <!-- トップバー -->
    <header id="top-bar">
      <div class="left-section">
        <div class="navbar-logo">
          <a href="/"><img src="/img/logo/th.png" alt="Logo"></a>
        </div>
      </div>

      <div class="search-container">
        <form class="pure-form" action="/search" method="get">
          <fieldset>
            <input id="searchbox" name="q" type="search" placeholder="検索" title="検索" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false">
          </fieldset>
        </form>
      </div>

      <nav id="top-nav">
        <a href="/bbs">掲示板</a>
        <a href="/proxypage">Proxy</a>
        <a href="/others">その他</a>
        <a href="/sitsumon">回答よろ</a>
      </nav>
    </header>

    <!-- 歯車ボタン（左下） -->
    <button class="settings-toggle" id="settingsToggle" aria-label="設定を開く" aria-expanded="false">
      <span class="gear" aria-hidden="true">⚙️</span>
    </button>

    <!-- 設定パネル（タブ付き） -->
    <div class="settings-panel" id="settingsPanel" role="dialog" aria-hidden="true" aria-labelledby="settingsTitle" aria-modal="false">
      <h4 id="settingsTitle">表示と再生の設定</h4>

      <div class="settings-tabs" role="tablist" aria-label="設定タブ">
        <button class="tab" role="tab" aria-selected="true" data-target="tab-load" id="tab-load-btn">読み込み方法</button>
        <button class="tab" role="tab" aria-selected="false" data-target="tab-play" id="tab-play-btn">再生設定</button>
      </div>

      <div id="tab-load" class="tab-panel" role="tabpanel" aria-labelledby="tab-load-btn">
        <div class="settings-row">
          <div>
            <label for="vcSelectPanel">再生モード</label>
            <div class="desc">リンク先を選択できます。設定はクッキーで保存されます。</div>
          </div>
          <div>
            <select id="vcSelectPanel" style="min-width:120px;">
              <option value="1">stream再生</option>
              <option value="2">高画質再生</option>
              <option value="3">nocookie</option>
              <option value="0">education</option>
            </select>
          </div>
        </div>

        <div class="settings-row">
          <div>
            <label for="proxyToggle">サムネイルプロキシ</label>
            <div class="desc">プロキシによるサムネイル取得をオンにします</div>
          </div>
          <div>
            <input id="proxyToggle" type="checkbox" />
          </div>
        </div>
      </div>

      <div id="tab-play" class="tab-panel" role="tabpanel" aria-labelledby="tab-play-btn" hidden>
        <div class="settings-row">
          <div>
            <label for="loopTogglePanel">ループ再生</label>
            <div class="desc">動画を繰り返し再生します</div>
          </div>
          <div>
            <input id="loopTogglePanel" type="checkbox" />
          </div>
        </div>

        <div class="settings-row">
          <div>
            <label for="autonextTogglePanel">次の動画を自動で読み込む</label>
            <div class="desc">再生終了後に次の動画へ自動で移動します</div>
          </div>
          <div>
            <input id="autonextTogglePanel" type="checkbox" />
          </div>
        </div>
      </div>

      <div style="padding-top:10px; text-align:right;">
        <button id="settingsSaveBtn" class="settings-save">保存</button>
      </div>
    </div>

    <div class="no-theme">
      <!-- メインコンテンツ -->
      <main class="main-content">
        <div class="video-container">
          <!-- 左カラム -->
          <div class="video-left">
            <div class="video-player-container">
              <div id="defaultPlayer" class="video-player-wrapper" aria-busy="false">
                <video id="player" controls playsinline preload="none">
                  {% for videourl in videourls %}
                    <source class="player-source" src="{{ videourl }}">
                  {% endfor %}
                </video>
                <div id="loader" role="status" aria-hidden="true"></div>
              </div>

              <div id="embeddedPlayer" class="umev" style="display:none;">
                <iframe width="100%" height="100%" src="https://www.youtube-nocookie.com/embed/{{ videoid }}" title="video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
              </div>
            </div>

            <div class="video-description" id="descriptionText">
              <a href="/channel/{{ author_id }}" style="display:inline-block; width:fit-content;">
                <div class="channel-profile">
                  <img src="{{ author_icon }}" alt="{{ author }} のアイコン" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;">
                  <span id="channel-name" style="margin-left:8px;vertical-align:middle;">{{ author }}</span>
                </div>
              </a>
              <h1>{{ video_title }}</h1>
              <p style="display:inline-block; margin-right:10px; vertical-align:super;">{{ view_count }}回視聴</p>
              <div style="display:inline-block;">
                <span class="material-symbols-outlined" style="display:inline-block; padding-right:5px;">thumb_up</span>
                <p style="display:inline-block; vertical-align:super;">{{ like_count }}</p>
              </div><br>
              {{ description | safe }}
            </div>

            <div class="comments-section">
              <h3>コメント</h3>
              <div id="comments"></div>
            </div>
          </div>

          <!-- 右カラム -->
          <div class="video-right">
            {% for rec_video in recommended_videos %}
            <div class="recomeention">
              <a href="/watch?v={{ rec_video['video_id'] }}">
                <div class="thumb-area" style="position:relative;">
                  <img loading="lazy" class="thumb-img" src="{% if proxy == 'True' %}/thumbnail?v={{ rec_video['video_id'] }}{% else %}https://img.youtube.com/vi/{{ rec_video['video_id'] }}/0.jpg{% endif %}" alt="{{ rec_video['title'] }}">
                  <span class="length">{{ rec_video["length_text"] }}</span>
                </div>
                <p>{{ rec_video["title"] }}</p>
              </a>
              <p>{{ rec_video["view_count_text"] }}回視聴</p>
              <a href="/channel/{{ rec_video['authorId'] }}">{{ rec_video["author"] }}</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </main>
    </div>

    <!-- Toast container -->
    <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

    <!-- 最新情報 -->
    <div class="latest-info" id="latestInfo" style="position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:120;">
      <h3>welcome!!</h3>
      <div id="infoContent">chatにきてください‼︎「その他」のところにあります‼︎</div>
    </div>

    <!-- 統合スクリプト（DOMContentLoaded 内で安全に初期化） -->
    <script>
    document.addEventListener('DOMContentLoaded', function(){
      /* -------------------- ユーティリティ -------------------- */
      function getCookie(name){ const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? decodeURIComponent(m.pop()) : null; }
      function setCookie(name, value, days){ const d = new Date(); d.setTime(d.getTime() + (days||30)*24*60*60*1000); document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/'; }
      function secToHMS(sec){ sec = Number(sec) || 0; const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = sec%60; return (h? h+':':'') + String(m).padStart(h?2:1,'0') + ':' + String(s).padStart(2,'0'); }

      /* -------------------- トースト実装（重複抑制・最大同時表示） -------------------- */
      (function initToast(){
        const wrap = document.getElementById('toastWrap');
        if (!wrap) return;
        const maxToasts = 3;
        const dedupe = new Map();

        function ensureSpace(){
          const toasts = wrap.querySelectorAll('.toast');
          if (toasts.length < maxToasts) return;
          let oldest = null;
          toasts.forEach(t => {
            const created = parseInt(t.getAttribute('data-created')||'0',10);
            if (!oldest || created < parseInt(oldest.getAttribute('data-created')||'0',10)) oldest = t;
          });
          if (oldest) dismiss(oldest);
        }

        function createToastElement(title, body){
          const el = document.createElement('div');
          el.className = 'toast';
          el.setAttribute('data-created', String(Date.now()));
          el.innerHTML = '<div class="title">' + (title||'通知') + '</div><div class="body">' + (body||'') + '</div>';
          const cx = document.createElement('button');
          cx.className = 'close-x';
          cx.setAttribute('aria-label','閉じる');
          cx.type = 'button';
          cx.textContent = '✕';
          el.appendChild(cx);
          return el;
        }

        function dismiss(el){
          if (!el || !el.parentNode) return;
          const key = el._toastKey;
          el.classList.remove('show');
          el.style.transform = 'translateX(14px) translateY(-8px) scale(.98)';
          el.style.opacity = '0';
          if (el._toastTimeoutId) clearTimeout(el._toastTimeoutId);
          if (key && dedupe.has(key)) dedupe.delete(key);
          setTimeout(()=> { try { el.remove(); } catch(e) {} }, 260);
        }

        function createOrRefreshToast(title, body, ttl = 4200){
          const key = (title||'') + '||' + (body||'');
          if (dedupe.has(key)){
            const info = dedupe.get(key);
            clearTimeout(info.timeoutId);
            info.timeoutId = setTimeout(()=> dismiss(info.el), ttl);
            info.expiresAt = Date.now() + ttl;
            focusToast(info.el);
            return info.el;
          }

          ensureSpace();
          const el = createToastElement(title, body);
          el._toastKey = key;
          wrap.appendChild(el);
          requestAnimationFrame(()=> el.classList.add('show') );
          const timeoutId = setTimeout(()=> dismiss(el), ttl);
          el._toastTimeoutId = timeoutId;
          dedupe.set(key, { el, timeoutId, expiresAt: Date.now() + ttl });

          const closeX = el.querySelector('.close-x');
          if (closeX) {
            closeX.addEventListener('click', function(e){
              e.stopPropagation();
              clearTimeout(el._toastTimeoutId);
              dismiss(el);
            });
          }

          // pointer drag handling (local to element)
          let startX = 0, currentX = 0, dragging = false;
          function onPointerDown(ev){
            dragging = true;
            el.classList.add('dragging');
            startX = ev.touches ? ev.touches[0].clientX : ev.clientX;
            currentX = startX;
            el.style.transition = 'none';
          }
          function onPointerMove(ev){
            if (!dragging) return;
            const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
            currentX = clientX;
            const dx = currentX - startX;
            el.style.transform = `translateX(${Math.max(0, dx)}px)`;
            el.style.opacity = String(Math.max(0, 1 - Math.abs(dx) / 300));
          }
          function onPointerUp(){
            if (!dragging) return;
            dragging = false;
            el.classList.remove('dragging');
            el.style.transition = '';
            const dx = currentX - startX;
            if (dx > 120) dismiss(el);
            else { el.style.transform = ''; el.style.opacity = ''; }
          }

          el.addEventListener('mousedown', onPointerDown);
          window.addEventListener('mousemove', onPointerMove);
          window.addEventListener('mouseup', onPointerUp);
          el.addEventListener('touchstart', onPointerDown, {passive:true});
          window.addEventListener('touchmove', onPointerMove, {passive:true});
          window.addEventListener('touchend', onPointerUp);

          return el;
        }

        // グローバル showToast
        if (!window.showToast) {
          window.showToast = function(title, body, ttl){
            createOrRefreshToast(title, body, typeof ttl === 'number' ? ttl : 4200);
          };
        }
      })();

      /* -------------------- 設定パネル タブ・保存・同期 -------------------- */
      (function initSettings(){
        // 初期化重複防止
        if (document.documentElement.dataset.settingsInit === '1') return;
        document.documentElement.dataset.settingsInit = '1';

        const settingsToggle = document.getElementById('settingsToggle');
        const settingsPanel = document.getElementById('settingsPanel');
        const saveBtn = document.getElementById('settingsSaveBtn');
        const vcSelect = document.getElementById('vcSelectPanel');
        const proxyToggle = document.getElementById('proxyToggle');
        const loopToggle = document.getElementById('loopTogglePanel');
        const autonextToggle = document.getElementById('autonextTogglePanel');
        const existingLoop = document.getElementById('loop');
        const existingAutonext = document.getElementById('autonextpage');

        // タブ切替
        const tabButtons = Array.from(document.querySelectorAll('.settings-tabs .tab'));
        function activateTab(btn){
          tabButtons.forEach(b => {
            const target = document.getElementById(b.dataset.target);
            const isActive = b === btn;
            b.setAttribute('aria-selected', isActive ? 'true' : 'false');
            if (target) target.hidden = !isActive;
          });
        }
        if (tabButtons.length) activateTab(tabButtons[0]);
        tabButtons.forEach(b => b.addEventListener('click', ()=> activateTab(b)));

        // 初期値読み込み
        try {
          if (vcSelect) vcSelect.value = getCookie('vc') || vcSelect.value || '0';
          if (proxyToggle) proxyToggle.checked = (getCookie('proxy') === 'True') || proxyToggle.checked;
          if (loopToggle) {
            const loopCookie = getCookie('loop');
            if (loopCookie !== null) loopToggle.checked = loopCookie === 'true';
            else if (existingLoop) loopToggle.checked = existingLoop.checked;
          }
          if (autonextToggle) {
            const autoCookie = getCookie('autonextpage');
            if (autoCookie !== null) autonextToggle.checked = autoCookie === 'true';
            else if (existingAutonext) autonextToggle.checked = existingAutonext.checked;
          }
        } catch(e){ console.warn('settings init error', e); }

        // 開閉ハンドラ
        function openSettings(){ if (!settingsPanel) return; settingsPanel.classList.add('open'); settingsPanel.setAttribute('aria-hidden','false'); settingsToggle.setAttribute('aria-expanded','true'); const focusTarget = settingsPanel.querySelector('select, input, button, [tabindex]:not([tabindex="-1"])'); if (focusTarget) focusTarget.focus(); }
        function closeSettings(){ if (!settingsPanel) return; settingsPanel.classList.remove('open'); settingsPanel.setAttribute('aria-hidden','true'); settingsToggle.setAttribute('aria-expanded','false'); settingsToggle.focus(); }

        if (settingsToggle && settingsPanel) {
          settingsToggle.addEventListener('click', function(e){ e.stopPropagation(); if (settingsPanel.classList.contains('open')) closeSettings(); else openSettings(); });
          document.addEventListener('click', function(e){ if (!settingsPanel.contains(e.target) && !settingsToggle.contains(e.target)) closeSettings(); });
          document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && settingsPanel.classList.contains('open')) closeSettings(); });
        }

        // 双方向同期：パネル -> 既存要素
        if (loopToggle && existingLoop) {
          loopToggle.addEventListener('change', function(){
            existingLoop.checked = this.checked;
            setCookie('loop', this.checked, 0.125);
            if (document.getElementById('player')) document.getElementById('player').loop = this.checked;
            if (window.showToast) window.showToast('ループ設定', this.checked ? 'ループを有効にしました' : 'ループを無効にしました');
          });
        }
        if (autonextToggle && existingAutonext) {
          autonextToggle.addEventListener('change', function(){
            existingAutonext.checked = this.checked;
            setCookie('autonextpage', this.checked, 0.125);
            if (window.showToast) window.showToast('自動遷移設定', this.checked ? '自動遷移を有効にしました' : '自動遷移を無効にしました');
          });
        }

        // 既存要素 -> パネル
        if (existingLoop && loopToggle) {
          existingLoop.addEventListener('change', function(){ loopToggle.checked = this.checked; setCookie('loop', this.checked, 0.125); if (document.getElementById('player')) document.getElementById('player').loop = this.checked; });
        }
        if (existingAutonext && autonextToggle) {
          existingAutonext.addEventListener('change', function(){ autonextToggle.checked = this.checked; setCookie('autonextpage', this.checked, 0.125); });
        }

        // 保存ボタン
        if (saveBtn) {
          saveBtn.addEventListener('click', function(){
            try {
              if (vcSelect) setCookie('vc', vcSelect.value, 30);
              if (proxyToggle) setCookie('proxy', proxyToggle.checked ? 'True' : 'False', 30);
              if (loopToggle) setCookie('loop', loopToggle.checked, 0.125);
              if (autonextToggle) setCookie('autonextpage', autonextToggle.checked, 0.125);
              if (window.showToast) window.showToast('設定を保存しました', '保存完了');
            } catch(e){ console.warn('save error', e); }
            closeSettings();
          });
        }

        // vc の即時反映（select change）
        function vcToPath(vc){ switch(String(vc)){ case '1': return '/watch'; case '2': return '/w'; case '3': return '/ume'; default: return '/edu'; } }
        function replaceToVcPath(vcValue){
          try {
            const targetPath = vcToPath(vcValue);
            const query = window.location.search || '';
            if (window.location.pathname === targetPath && window.location.search === query) return;
            location.replace(targetPath + query);
          } catch(e){ console.warn('vc replace failed', e); }
        }
        if (vcSelect) {
          vcSelect.addEventListener('change', function(){ setCookie('vc', this.value, 30); replaceToVcPath(this.value); });
        }
      })();

      /* -------------------- 動画プレーヤー関連（ローダー・コメントジャンプ等） -------------------- */
      (function initPlayer(){
        const player = document.getElementById('player');
        const loader = document.getElementById('loader');
        if (player) {
          // ローダー表示
          const showLoaderIfStart = () => { if (player.currentTime === 0 && loader) loader.style.display = 'block'; };
          const hideLoaderWhenProgress = () => { if (player.currentTime > 0 && loader) { loader.style.display = 'none'; player.removeEventListener('timeupdate', hideLoaderWhenProgress); player.removeEventListener('playing', hideLoaderWhenProgress); } };
          player.addEventListener('play', showLoaderIfStart);
          player.addEventListener('timeupdate', hideLoaderWhenProgress);
          player.addEventListener('playing', hideLoaderWhenProgress);

          // currentTime from query t
          try {
            const params = new URLSearchParams(window.location.search);
            const t = params.get('t');
            const tNum = t ? Number(t) : 0;
            if (!Number.isNaN(tNum) && tNum > 0) player.currentTime = tNum;
          } catch(e){}

          // ended -> auto next handled elsewhere via cookie/autonextpage
          player.addEventListener('ended', function(){
            const enable_auto = (document.getElementById('autonextpage') && document.getElementById('autonextpage').checked) || (document.getElementById('autonextTogglePanel') && document.getElementById('autonextTogglePanel').checked);
            if (enable_auto) {
              setTimeout(()=> { try { location.replace("/watch?v={{ recommended_videos[0]['video_id'] }}"); } catch(e){} }, 5000);
            }
          });

          // keyboard play/pause (space or K)
          window.addEventListener('keydown', function(e){
            const active = document.activeElement;
            if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable)) return;
            if (e.code === 'Space' || e.key === 'k' || e.key === 'K' || e.keyCode === 32 || e.keyCode === 75) {
              e.preventDefault();
              if (player.paused) player.play(); else player.pause();
            }
          });

          // network error check
          setTimeout(()=> {
            if (player.networkState === 3) {
              const info = document.getElementById('video_info');
              if (info) {
                info.innerHTML = '動画の読み込みに失敗しました。再読み込み等をお試し下さい。';
                const reloadBtn = document.createElement('button');
                reloadBtn.textContent = 'リロード';
                reloadBtn.addEventListener('click', ()=> location.replace(location.href));
                info.appendChild(reloadBtn);
              }
              try { player.remove(); } catch(e){}
            }
          }, 1000);

          // current time display update if element exists
          const currentTimeElem = document.getElementById('player_current_time');
          if (currentTimeElem) {
            setInterval(()=> { currentTimeElem.textContent = secToHMS(Math.floor(player.currentTime || 0)); }, 250);
          }
        }

        // コメント読み込みとジャンプリンク
        const commentsDiv = document.getElementById('comments');
        if (commentsDiv) {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/comments?v=' + encodeURIComponent((new URLSearchParams(window.location.search)).get('v') || ''));
          xhr.onload = function(){
            if (xhr.status === 200) {
              commentsDiv.innerHTML = xhr.responseText;
              const aTags = commentsDiv.getElementsByTagName('a');
              for (let i=0;i<aTags.length;i++){
                const jump = aTags[i].getAttribute('data-jump-time');
                if (jump) {
                  aTags[i].addEventListener('click', function(e){ e.preventDefault(); const sec = Number(jump); if (!Number.isNaN(sec) && document.getElementById('player')) document.getElementById('player').currentTime = sec; });
                }
              }
            } else {
              commentsDiv.textContent = 'コメントの読み込みに失敗しました。再読み込み等をお試し下さい。';
            }
          };
          xhr.onerror = function(){ commentsDiv.textContent = 'コメントの読み込みに失敗しました。ネットワークを確認してください。'; };
          xhr.send();
        }
      })();

      /* -------------------- 検索オートコンプリート（jQueryがある場合） -------------------- */
      (function initAutocomplete(){
        try {
          if (window.jQuery && document.getElementById('searchbox')) {
            $('#searchbox').autocomplete({
              source: function(request, response) {
                const url = "/suggest?keyword=" + encodeURIComponent(request.term);
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url);
                xhr.onload = function(){ try { response(JSON.parse(xhr.responseText)); } catch(e){ response([]); } };
                xhr.onerror = function(){ response([]); };
                xhr.send();
              },
              delay: 300
            });
          }
        } catch(e){}
      })();

      /* -------------------- 最新情報トグル -------------------- */
      (function initLatestInfo(){
        const infoContent = document.getElementById('infoContent');
        if (!infoContent) return;
        let toggle = true;
        setInterval(()=> {
          infoContent.textContent = toggle ? "高画質機能追加！左にある高画質再生を押してみて‼︎" : "chatにきてください‼︎「その他」のところにあります‼︎";
          toggle = !toggle;
        }, 5000);
      })();

      /* -------------------- 履歴登録 -------------------- */
      (function addToHistory(){
        try {
          const videoData = {
            video_id: "{{ videoid }}",
            thumbnail: "{% if proxy == 'True' %}/thumbnail?v={{ videoid }}{% else %}https://img.youtube.com/vi/{{ videoid }}/0.jpg{% endif %}",
            length: "{{ length_text }}",
            title: "{{ video_title }}",
            channel: "{{ author }}",
            channel_id: "{{ author_id }}",
            view_count: "{{ view_count }}",
            published: "{{ published_date }}"
          };
          let history = localStorage.getItem('watchHistory');
          history = history ? JSON.parse(history) : [];
          history = history.filter(item => item.video_id !== videoData.video_id);
          history.unshift(videoData);
          if (history.length > 50) history = history.slice(0,50);
          localStorage.setItem('watchHistory', JSON.stringify(history));
        } catch(e){}
      })();

    }); // DOMContentLoaded end
    </script>
  </body>
</html>
